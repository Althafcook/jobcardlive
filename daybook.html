<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daybook</title>
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<style>
/* ===== SAME CSS (UNCHANGED) ===== */
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:#111;
  color:#ddd;
}
/* (CSS unchanged ‚Äì skipped for brevity) */
</style>
</head>

<body>

<div class="header">
  <h1>Daybook</h1>
  <div class="summary" id="summary"></div>
  <div class="home-btn" onclick="location.href='index.html'">üè† Home</div>
  <div class="date" id="currentDate"></div>
</div>

<div class="empty-state" id="emptyState">
  <div class="empty-card">
    <lottie-player
      src="https://assets7.lottiefiles.com/packages/lf20_xlmz9xwm.json"
      background="transparent"
      speed="1"
      style="width:150px;height:150px"
      loop autoplay>
    </lottie-player>
    <p><b>Today no jobcard entered</b></p>
  </div>
</div>

<div class="table-wrapper" id="tableWrapper">
<table>
<thead>
<tr>
  <th>No</th><th>Date</th><th>Time</th><th>Jobcard No.</th>
  <th>AIC</th><th>Customer Name</th><th>Executive</th>
  <th>Vehicle</th><th>Chase No.</th>
</tr>
</thead>
<tbody id="daybookBody"></tbody>
</table>
</div>

<div class="loader hidden" id="loader">
  <div class="meter">
    <div class="needle"></div>
    <div class="timer" id="timer">0s</div>
  </div>
</div>

<script>
const DATA_URL =
"https://script.google.com/macros/s/AKfycbz0v1ohNeufeJNvvbcuydkNAPgG_YL9YIGsf-1DRp4rd3mjcGd-NQocWfOgPqbknr8X/exec";

const STATE_KEY = "DAYBOOK_STATE";

let allRows = [];
let currentFilter = "TOTAL";
let isFetching = false;
let timerInt = null;
let firstLoad = true;

currentDate.innerText =
new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});

/* ===== STATE SAVE / RESTORE ===== */
function saveState(){
  sessionStorage.setItem(STATE_KEY, JSON.stringify({
    rows: allRows,
    filter: currentFilter,
    scroll: tableWrapper.scrollTop
  }));
}

function restoreState(){
  const s = sessionStorage.getItem(STATE_KEY);
  if(!s) return false;

  try{
    const state = JSON.parse(s);
    allRows = state.rows || [];
    currentFilter = state.filter || "TOTAL";

    renderSummary(allRows);
    renderTable();

    requestAnimationFrame(()=>{
      tableWrapper.scrollTop = state.scroll || 0;
    });

    emptyState.style.display = allRows.length ? "none" : "flex";
    tableWrapper.style.display = allRows.length ? "block" : "none";

    return true;
  }catch(e){
    return false;
  }
}

/* ===== BACK NAVIGATION FIX ===== */
window.addEventListener("pageshow", e=>{
  if(e.persisted){
    restoreState();
  }
});

/* ===== LOADER ===== */
function showLoader(){
  if(timerInt) return;
  let start=Date.now();
  loader.classList.remove("hidden");
  timerInt=setInterval(()=>{
    timer.innerText=Math.floor((Date.now()-start)/1000)+"s";
  },500);
}
function hideLoader(){
  clearInterval(timerInt);
  timerInt=null;
  loader.classList.add("hidden");
}

/* ===== SUMMARY ===== */
const aicClass=n=>({
  Arun:"aic-arun",Siyad:"aic-siyad",
  Sajid:"aic-sajid",Ashraf:"aic-ashraf"
}[n]||"");

function renderSummary(rows){
  const c={Arun:0,Siyad:0,Sajid:0,Ashraf:0};
  rows.forEach(r=>c[r.aic]++);
  summary.innerHTML=`
    <span class="sum-arun ${currentFilter==='Arun'?'active':''}" onclick="setFilter('Arun')">Arun ${c.Arun}</span>
    <span class="sum-siyad ${currentFilter==='Siyad'?'active':''}" onclick="setFilter('Siyad')">Siyad ${c.Siyad}</span>
    <span class="sum-sajid ${currentFilter==='Sajid'?'active':''}" onclick="setFilter('Sajid')">Sajid ${c.Sajid}</span>
    <span class="sum-ashraf ${currentFilter==='Ashraf'?'active':''}" onclick="setFilter('Ashraf')">Ashraf ${c.Ashraf}</span>
    <span class="sum-total ${currentFilter==='TOTAL'?'active':''}" onclick="setFilter('TOTAL')">Total ${rows.length}</span>`;
}

function setFilter(f){
  currentFilter=f;
  renderTable();
  saveState();
}

/* ===== TABLE ===== */
function renderTable(){
  daybookBody.innerHTML="";
  const rows=currentFilter==="TOTAL"
    ? allRows
    : allRows.filter(r=>r.aic===currentFilter);

  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.onclick=()=>jobcardClick(r);
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${r.date}</td>
      <td>${r.time}</td>
      <td>${r.jobcard}</td>
      <td class="${aicClass(r.aic)}">${r.aic}</td>
      <td>${r.customer}</td>
      <td>${r.executive}</td>
      <td>${r.vehicle}</td>
      <td>${r.chassis}</td>`;
    daybookBody.appendChild(tr);
  });
}

/* ===== CLICK ===== */
const JOBCARD_API =
"https://script.google.com/macros/s/AKfycbwr0Ltlv2tRUZWt8CnDtH7Zx3qcG3CzIEuMBncow_FS0SW3f7pyEaTziYnGtNvcOSYZ-w/exec";

function jobcardClick(row){
  saveState(); // üî• important

  fetch(
    JOBCARD_API + "?mode=setChase&chase=" + encodeURIComponent(row.chassis),
    { mode:"no-cors" }
  );

  location.href = "jobcard_arun.html";
}

/* ===== LOAD ===== */
async function loadDaybook(){
  if(isFetching) return;
  isFetching=true;

  try{
    if(firstLoad && !restoreState()){
      showLoader();
    }

    const r=await fetch(DATA_URL,{cache:"no-store"});
    const d=await r.json();
    const rows = Array.isArray(d.rows) ? d.rows : [];

    hideLoader();

    allRows=rows;
    renderSummary(allRows);
    renderTable();
    saveState();

    emptyState.style.display = rows.length ? "none" : "flex";
    tableWrapper.style.display = rows.length ? "block" : "none";

    firstLoad=false;
  }catch(e){
    console.error("Daybook error:", e);
    hideLoader();
  }finally{
    isFetching=false;
  }
}

loadDaybook();
setInterval(loadDaybook,30000);
</script>
</body>
</html>
