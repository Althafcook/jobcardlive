<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daybook</title>
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<style>
/* üîπ SAME STYLES ‚Äì NO CHANGE */
body{margin:0;font-family:"Segoe UI",Arial,sans-serif;background:#111;color:#ddd}
/* HEADER */
.header{padding:8px 12px;background:#000;display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;border-bottom:1px solid #333;gap:10px}
.header h1{margin:0;font-size:18px;font-weight:600;color:#fff}
.home-btn{cursor:pointer;font-size:13px;opacity:.9;white-space:nowrap;color:#ccc}
.summary{display:flex;gap:6px;justify-content:center;font-size:12px;overflow-x:auto}
.summary span{padding:3px 8px;border-radius:4px;font-weight:600;cursor:pointer;white-space:nowrap;opacity:.85}
.summary span.active{outline:2px solid #fff;opacity:1}
.sum-arun{background:#d94a4a;color:#fff}
.sum-siyad{background:#8bc34a;color:#000}
.sum-sajid{background:#f2d23c;color:#000}
.sum-ashraf{background:#eee;color:#000}
.sum-total{background:#333;color:#fff}
.date{font-size:12px;color:#aaa}

/* TABLE */
.table-wrapper{height:calc(100vh - 56px);overflow:auto}
table{width:100%;min-width:980px;border-collapse:collapse}
thead th{position:sticky;top:0;background:#000;color:#ff4d4d;font-size:12px;padding:8px}
tbody td{font-size:12px;padding:4px 6px;border-bottom:1px solid #222;text-align:center;color:#cfcfcf}

/* EMPTY */
.empty-state{display:none;height:calc(100vh - 56px);align-items:center;justify-content:center}
.empty-card{background:#1b1b1b;border:1px solid #333;border-radius:16px;padding:26px;text-align:center}

/* LOADER */
.loader{position:fixed;inset:0;background:#000c;display:flex;align-items:center;justify-content:center;z-index:999}
.hidden{display:none}
.meter{width:160px;height:160px;border-radius:50%;border:8px solid #333;position:relative}
.needle{width:4px;height:70px;background:red;position:absolute;bottom:50%;left:50%;transform-origin:bottom;animation:sweep 1.2s linear infinite}
@keyframes sweep{from{transform:rotate(-90deg)}to{transform:rotate(90deg)}}
.timer{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:18px}
</style>
</head>

<body>

<div class="header">
  <h1>Daybook</h1>
  <div class="summary" id="summary"></div>
  <div class="home-btn" onclick="location.href='index.html'">üè† Home</div>
  <div class="date" id="currentDate"></div>
</div>

<div class="empty-state" id="emptyState">
  <div class="empty-card">
    <lottie-player src="https://assets7.lottiefiles.com/packages/lf20_xlmz9xwm.json"
      background="transparent" speed="1" style="width:140px;height:140px" loop autoplay>
    </lottie-player>
    <p><b>Today no jobcard entered</b></p>
  </div>
</div>

<div class="table-wrapper" id="tableWrapper">
<table>
<thead>
<tr>
  <th>No</th><th>Date</th><th>Time</th><th>Jobcard</th>
  <th>AIC</th><th>Customer</th><th>Executive</th>
  <th>Vehicle</th><th>Chassis</th>
</tr>
</thead>
<tbody id="daybookBody"></tbody>
</table>
</div>

<div class="loader hidden" id="loader">
  <div class="meter">
    <div class="needle"></div>
    <div class="timer" id="timer">0s</div>
  </div>
</div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbz0v1ohNeufeJNvvbcuydkNAPgG_YL9YIGsf-1DRp4rd3mjcGd-NQocWfOgPqbknr8X/exec";
const JOBCARD_API = "https://script.google.com/macros/s/AKfycbwr0Ltlv2tRUZWt8CnDtH7Zx3qcG3CzIEuMBncow_FS0SW3f7pyEaTziYnGtNvcOSYZ-w/exec";

let allRows=[];
let isFetching=false;
let timerInt=null;
let hasLoadedOnce=false;

currentDate.innerText =
new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});

/* LOADER */
function showLoader(){
  if(timerInt) return;
  loader.classList.remove("hidden");
  let start=Date.now();
  timerInt=setInterval(()=>timer.innerText=Math.floor((Date.now()-start)/1000)+"s",500);
}
function hideLoader(){
  clearInterval(timerInt);
  timerInt=null;
  loader.classList.add("hidden");
}

/* TABLE */
function renderTable(){
  daybookBody.innerHTML="";
  allRows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.onclick=()=>jobcardClick(r);
    tr.innerHTML=`
      <td>${i+1}</td><td>${r.date}</td><td>${r.time}</td>
      <td>${r.jobcard}</td><td>${r.aic}</td>
      <td>${r.customer}</td><td>${r.executive}</td>
      <td>${r.vehicle}</td><td>${r.chassis}</td>`;
    daybookBody.appendChild(tr);
  });
}

/* CLICK */
function jobcardClick(row){
  fetch(JOBCARD_API+"?mode=setChase&chase="+encodeURIComponent(row.chassis),{mode:"no-cors"});
  location.href="jobcard_arun.html";
}

/* LOAD */
async function loadDaybook(){
  if(isFetching) return;
  isFetching=true;

  if(!hasLoadedOnce) showLoader();

  try{
    const r=await fetch(DATA_URL,{cache:"no-store"});
    const d=await r.json();
    allRows = Array.isArray(d.rows)?d.rows:[];
    hideLoader();

    if(allRows.length){
      emptyState.style.display="none";
      tableWrapper.style.display="block";
      renderTable();
    }else{
      tableWrapper.style.display="none";
      emptyState.style.display="flex";
    }

    hasLoadedOnce=true;
  }catch(e){
    hideLoader();
    console.error(e);
  }finally{
    isFetching=false;
  }
}

/* üî• BACK NAVIGATION FIX */
window.addEventListener("pageshow",e=>{
  if(e.persisted){
    hideLoader();
    if(allRows.length){
      emptyState.style.display="none";
      tableWrapper.style.display="block";
    }
  }
});

loadDaybook();
setInterval(loadDaybook,30000);
</script>
</body>
</html>
