<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Jobcard</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:Segoe UI}
.table{width:100%;border-collapse:collapse}
td,th{padding:6px;border-bottom:1px solid #222}
</style>
</head>

<body>

<h3 id="cust"></h3>
<div id="meta"></div>

<table class="table">
<thead><tr><th>No</th><th>Item</th><th>Status</th></tr></thead>
<tbody id="items"></tbody>
</table>

<script>
const API="https://script.google.com/macros/s/AKfycbw4dVdfgm3NkISHwE_v8CNSrMbOtx75SZI4DPs1dM2b6qm1gchMSRPL41JkN-Vn5RAwrg/exec";
const chassis=new URLSearchParams(location.search).get("chassis");

/* instant top */
const top=sessionStorage.getItem("JOB_CARD_DATA");
if(top){
  const r=JSON.parse(top);
  cust.innerText=r.customer||"";
  meta.innerText=`${r.vehicle} | ${r.chassis}`;
}

/* instant items if cached */
const cached=sessionStorage.getItem("JOB_CARD_PAYLOAD");
if(cached){
  const d=JSON.parse(cached);
  render(d.items||[]);
}

/* background refresh */
fetch(API+"?mode=jobcard&chassis="+encodeURIComponent(chassis))
.then(r=>r.json())
.then(d=>{
  cust.innerText=d.customer||"";
  meta.innerText=`${d.vehicle} | ${d.chassis}`;
  render(d.items||[]);
  sessionStorage.setItem("JOB_CARD_PAYLOAD",JSON.stringify(d));
});

function render(items){
  itemsBody.innerHTML="";
  items.forEach((it,i)=>{
    itemsBody.insertAdjacentHTML("beforeend",
      `<tr><td>${i+1}</td><td>${it.item_partnumber||""}</td><td>${it.given_status==1?"Pending":"Done"}</td></tr>`
    );
  });
}
</script>

</body>
</html>
